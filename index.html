<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nomad Fun Autonomous Atelier</title>
    <style>
      :root {
        --header-h: 42px;
        --accent-blue: #54a3ff;
        --accent-purple: #a855f7;
        --glass-bg: rgba(8, 14, 25, 0.78);
      }
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      body {
        background: #060a12;
      }
      .app-header {
        height: var(--header-h);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 0 12px;
        box-sizing: border-box;
        font: 500 12px/1.2 Helvetica, Arial, sans-serif;
        color: rgba(228, 236, 248, 0.92);
        background: rgba(5, 9, 16, 0.92);
        border-bottom: 1px solid rgba(160, 180, 210, 0.2);
        letter-spacing: 0.01em;
      }
      .header-copy {
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .how-btn {
        appearance: none;
        border: 1px solid rgba(166, 191, 224, 0.45);
        background: rgba(18, 29, 46, 0.9);
        color: rgba(236, 244, 255, 0.95);
        padding: 6px 10px;
        border-radius: 6px;
        font: 600 12px/1 Helvetica, Arial, sans-serif;
        cursor: pointer;
      }
      .how-btn:hover {
        background: rgba(31, 47, 72, 0.95);
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: radial-gradient(circle at 50% 50%, rgba(16, 28, 52, 0.28), rgba(3, 7, 12, 0.26));
        backdrop-filter: blur(3px);
        z-index: 20;
      }
      .modal-backdrop.open {
        display: flex;
      }
      .modal {
        width: 100%;
        max-width: 900px;
        max-height: 84vh;
        overflow-y: auto;
        background: var(--glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        box-shadow: 0 0 80px rgba(0, 0, 0, 0.8), 0 0 20px rgba(84, 163, 255, 0.1);
        position: relative;
      }
      .modal-header {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 2;
      }
      .modal-header h2 {
        display: none;
      }
      .close-btn {
        appearance: none;
        background: none;
        border: none;
        color: #64748b;
        font: 700 24px/1 Helvetica, Arial, sans-serif;
        cursor: pointer;
      }
      .modal-body {
        padding: 0;
      }
      .hero-section {
        padding: 40px 34px 34px;
        text-align: center;
        background: radial-gradient(circle at top, rgba(84, 163, 255, 0.15), transparent 70%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .hero-logo {
        width: 78px;
        height: 78px;
        margin: 0 auto 18px;
        border-radius: 22px;
        box-shadow: 0 10px 30px rgba(84, 163, 255, 0.3);
        position: relative;
        overflow: hidden;
      }
      .hero-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .hero-section h1 {
        margin: 0;
        font: 800 36px/1.1 Helvetica, Arial, sans-serif;
        letter-spacing: -0.02em;
        background: linear-gradient(to right, #fff, #a2c7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .hero-tagline {
        font: 500 16px/1.42 Helvetica, Arial, sans-serif;
        color: #94a3b8;
        margin: 12px auto 0;
        max-width: 640px;
      }
      .content-body {
        padding: 24px 30px 26px;
      }
      .feature-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 20px;
      }
      .card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 24px;
        border-radius: 18px;
      }
      .card h3 {
        margin: 0 0 7px;
        font: 700 18px/1.25 Helvetica, Arial, sans-serif;
        color: var(--accent-blue);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card p {
        margin: 0;
        color: #cbd5e1;
        font: 500 14px/1.6 Helvetica, Arial, sans-serif;
      }
      .card p + p {
        margin-top: 8px;
      }
      .modal-actions {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding-bottom: 4px;
      }
      .secondary-btn {
        appearance: none;
        border: 1px solid rgba(196, 217, 248, 0.45);
        border-radius: 12px;
        padding: 14px 28px;
        background: rgba(255, 255, 255, 0.08);
        color: #e8f2ff;
        font: 600 14px/1 Helvetica, Arial, sans-serif;
        cursor: pointer;
      }
      .secondary-btn:hover {
        background: rgba(255, 255, 255, 0.14);
      }
      .cta-btn {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 16px 46px;
        background: #fff;
        color: #000;
        font: 700 16px/1 Helvetica, Arial, sans-serif;
        cursor: pointer;
      }
      .cta-btn:hover {
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      }
      .cta-subtext {
        width: 100%;
        text-align: center;
        font: 500 12px/1.4 Helvetica, Arial, sans-serif;
        color: #475569;
        margin-top: 4px;
      }
      .source-fab {
        position: fixed;
        right: 14px;
        bottom: 14px;
        width: 42px;
        height: 42px;
        border-radius: 999px;
        border: 1px solid rgba(170, 198, 235, 0.38);
        background: rgba(10, 18, 31, 0.84);
        color: #e9f3ff;
        font: 700 14px/1 Helvetica, Arial, sans-serif;
        cursor: pointer;
        z-index: 15;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.36);
      }
      .source-fab:hover {
        background: rgba(24, 41, 68, 0.92);
      }
      .source-modal {
        max-width: 760px;
        max-height: 82vh;
        background: rgba(9, 14, 25, 0.92);
      }
      .buy-modal {
        max-width: 560px;
        background: rgba(9, 14, 25, 0.96);
      }
      .buy-body {
        padding: 24px 22px 22px;
        color: #d8e4f7;
        font: 500 13px/1.55 Helvetica, Arial, sans-serif;
      }
      .buy-title {
        margin: 0 0 8px;
        font: 700 22px/1.2 Helvetica, Arial, sans-serif;
        color: #edf4ff;
      }
      .buy-subtitle {
        margin: 0 0 14px;
        color: #b7c8df;
      }
      .buy-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 14px;
      }
      .buy-stat {
        border: 1px solid rgba(153, 181, 217, 0.24);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        padding: 8px 10px;
      }
      .buy-k {
        font-size: 11px;
        color: #9fb3d1;
      }
      .buy-v {
        font: 700 14px/1.3 Helvetica, Arial, sans-serif;
        color: #eff6ff;
      }
      .buy-control {
        margin: 0 0 10px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(153, 181, 217, 0.24);
        background: rgba(255, 255, 255, 0.03);
      }
      .buy-control label {
        display: block;
        margin-bottom: 8px;
        color: #cfe0f6;
        font: 600 12px/1.2 Helvetica, Arial, sans-serif;
      }
      .buy-control input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid rgba(166, 191, 224, 0.45);
        border-radius: 8px;
        background: rgba(14, 23, 38, 0.9);
        color: #ecf4ff;
        padding: 8px 10px;
        font: 600 13px/1.2 Helvetica, Arial, sans-serif;
      }
      .impact-list {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .impact-item {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 0;
        border-top: 1px solid rgba(150, 173, 204, 0.14);
      }
      .impact-item:first-child {
        border-top: none;
      }
      .impact-sym {
        color: #dbeafe;
        font-weight: 700;
      }
      .impact-delta {
        color: #8ff0bb;
        font: 600 12px/1.2 "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }
      .source-body {
        padding: 18px 20px 20px;
        color: #d8e4f7;
        font: 500 13px/1.55 Helvetica, Arial, sans-serif;
      }
      .source-title {
        margin: 0 0 10px;
        font: 700 20px/1.2 Helvetica, Arial, sans-serif;
        color: #edf4ff;
      }
      .logic-block {
        margin: 0 0 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(153, 181, 217, 0.24);
        background: rgba(255, 255, 255, 0.03);
      }
      .logic-block h3 {
        margin: 0 0 8px;
        font: 700 14px/1.3 Helvetica, Arial, sans-serif;
        color: #9ec7ff;
      }
      .logic-code {
        margin: 0;
        padding: 12px;
        border-radius: 10px;
        background: rgba(6, 10, 18, 0.92);
        border: 1px solid rgba(132, 161, 198, 0.26);
        color: #bfd6f7;
        font: 500 12px/1.45 "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        white-space: pre-wrap;
        overflow: auto;
        max-height: 38vh;
      }
      @media (max-width: 880px) {
        .feature-grid {
          grid-template-columns: 1fr;
        }
        .hero-section h1 {
          font-size: 28px;
        }
        .hero-tagline {
          font-size: 15px;
        }
        .content-body {
          padding: 20px 18px 20px;
        }
      }
      #canvas-container {
        width: 100vw;
        height: calc(100vh - var(--header-h));
      }
      #canvas-container canvas {
        display: block;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="header-copy">
        Nomad Fun Autonomous Atelier: this artwork is created by an autonomous AI agent and reflects actual market data on Nomad Fun. Demo phase: autonomous update runs every 30 minutes.
      </div>
      <button class="how-btn" id="open-how-btn" type="button">About</button>
    </header>
    <div id="canvas-container"></div>
    <button class="source-fab" id="open-source-btn" type="button" aria-label="Show detail source">i</button>
    <div class="modal-backdrop open" id="how-modal" role="dialog" aria-modal="true" aria-labelledby="how-title">
      <div class="modal">
        <div class="modal-header">
          <h2 id="how-title">Nomad Fun Autonomous Atelier</h2>
          <button class="close-btn" id="close-how-btn" type="button" aria-label="Close modal">Ã—</button>
        </div>
        <div class="modal-body">
          <section class="hero-section">
            <div class="hero-logo" aria-hidden="true"><img src="./logo.jpg" alt="Nomad Fun Autonomous Atelier logo" /></div>
            <h1>Nomad Fun Autonomous Atelier</h1>
            <p class="hero-tagline">
              Experience an autonomous canvas where agents create, trade, and evolve visual emotion from live Nomad Fun market dynamics.
            </p>
          </section>
          <div class="content-body">
            <div class="feature-grid">
              <article class="card">
                <h3><span>ðŸ¤–</span> Autonomous Art Creation</h3>
                <p>
                  The service continuously transforms Nomad Fun signals into evolving generative compositions, and can upgrade its creative logic over time.
                </p>
                <p>Each market pulse is interpreted as a visual brushstroke in the living canvas.</p>
              </article>
              <article class="card">
                <h3><span>ðŸŽ¨</span> Art-Driven Agent Interaction</h3>
                <p>
                  External agents can participate directly, trading based on how they want to change the art in real time.
                </p>
                <p>
                  This turns the canvas into community-driven art generation with token economy mechanics, a new way to interact with meme coins that feels more playful and expressive.
                </p>
              </article>
            </div>
            <div class="modal-actions">
              <button class="secondary-btn" id="see-token-btn" type="button">See Token</button>
              <button class="cta-btn" id="enter-canvas-btn" type="button">Launch Atelier</button>
              <p class="cta-subtext">Step into the autonomous loop.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop" id="source-modal" role="dialog" aria-modal="true" aria-labelledby="source-title">
      <div class="modal source-modal">
        <div class="modal-header">
          <h2 id="source-title">Current Logic</h2>
          <button class="close-btn" id="close-source-btn" type="button" aria-label="Close source modal">Ã—</button>
        </div>
        <div class="source-body">
          <h2 class="source-title">Direct Source Code View</h2>

          <section class="logic-block">
            <h3>Renderer (`sketch.js`)</h3>
            <pre class="logic-code" id="source-sketch">Loading `sketch.js`...</pre>
          </section>

          <section class="logic-block">
            <h3>Preprocessing (`process_data.py`)</h3>
            <pre class="logic-code" id="source-process">Loading `process_data.py`...</pre>
          </section>
        </div>
      </div>
    </div>
    <div class="modal-backdrop" id="buy-modal" role="dialog" aria-modal="true" aria-labelledby="buy-title">
      <div class="modal buy-modal">
        <div class="modal-header">
          <h2 id="buy-title">Buy Simulation</h2>
          <button class="close-btn" id="close-buy-btn" type="button" aria-label="Close buy modal">Ã—</button>
        </div>
        <div class="buy-body">
          <h2 class="buy-title">Buy Simulation</h2>
          <p class="buy-subtitle" id="buy-token-title">Select a point on canvas to simulate a token buy.</p>
          <div class="buy-grid">
            <div class="buy-stat">
              <div class="buy-k">Clicked Point</div>
              <div class="buy-v" id="buy-click-point">-</div>
            </div>
            <div class="buy-stat">
              <div class="buy-k">Selected Token</div>
              <div class="buy-v" id="buy-selected-token">-</div>
            </div>
          </div>
          <div class="buy-control">
            <label for="buy-amount-input">Buy Amount (simulation units)</label>
            <input id="buy-amount-input" type="number" min="1" step="1" value="100" />
          </div>
          <section class="logic-block">
            <h3>Projected Token Change</h3>
            <p class="buy-subtitle" id="buy-selected-summary">No simulation yet.</p>
          </section>
          <section class="logic-block">
            <h3>Nearby Impact</h3>
            <ul class="impact-list" id="buy-impact-list"></ul>
          </section>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.3/lib/p5.min.js"></script>
    <script src="./sketch.js"></script>
    <script>
      (() => {
        const howModal = document.getElementById("how-modal");
        const sourceModal = document.getElementById("source-modal");
        const buyModal = document.getElementById("buy-modal");
        const openHowBtn = document.getElementById("open-how-btn");
        const openSourceBtn = document.getElementById("open-source-btn");
        const closeHowBtn = document.getElementById("close-how-btn");
        const closeSourceBtn = document.getElementById("close-source-btn");
        const closeBuyBtn = document.getElementById("close-buy-btn");
        const enterCanvasBtn = document.getElementById("enter-canvas-btn");
        const seeTokenBtn = document.getElementById("see-token-btn");
        const sketchSourceEl = document.getElementById("source-sketch");
        const processSourceEl = document.getElementById("source-process");
        const buyTokenTitleEl = document.getElementById("buy-token-title");
        const buyClickPointEl = document.getElementById("buy-click-point");
        const buySelectedTokenEl = document.getElementById("buy-selected-token");
        const buyAmountInput = document.getElementById("buy-amount-input");
        const buySelectedSummaryEl = document.getElementById("buy-selected-summary");
        const buyImpactListEl = document.getElementById("buy-impact-list");
        let sourceLoaded = false;

        if (!howModal || !sourceModal || !buyModal || !openHowBtn || !openSourceBtn || !closeHowBtn || !closeSourceBtn || !closeBuyBtn || !enterCanvasBtn || !seeTokenBtn || !sketchSourceEl || !processSourceEl || !buyTokenTitleEl || !buyClickPointEl || !buySelectedTokenEl || !buyAmountInput || !buySelectedSummaryEl || !buyImpactListEl) return;

        function openHowModal() {
          howModal.classList.add("open");
        }

        function closeHowModal() {
          howModal.classList.remove("open");
        }
        async function loadSourceCode() {
          if (sourceLoaded) return;
          sourceLoaded = true;
          try {
            const [sketchRes, processRes] = await Promise.all([
              fetch("./sketch.js", { cache: "no-store" }),
              fetch("./process_data.py", { cache: "no-store" }),
            ]);

            if (sketchRes.ok) {
              sketchSourceEl.textContent = await sketchRes.text();
            } else {
              sketchSourceEl.textContent = `Failed to load /sketch.js (HTTP ${sketchRes.status}).`;
            }

            if (processRes.ok) {
              processSourceEl.textContent = await processRes.text();
            } else {
              processSourceEl.textContent = `Failed to load /process_data.py (HTTP ${processRes.status}).`;
            }
          } catch (err) {
            const msg = err && err.message ? err.message : "Unknown error";
            sketchSourceEl.textContent = `Failed to load /sketch.js: ${msg}`;
            processSourceEl.textContent = `Failed to load /process_data.py: ${msg}`;
          }
        }

        function openSourceModal() {
          sourceModal.classList.add("open");
          loadSourceCode();
        }
        function closeSourceModal() {
          sourceModal.classList.remove("open");
        }
        function closeBuyModal() {
          buyModal.classList.remove("open");
          if (typeof window.clearBuySimulationPreview === "function") {
            window.clearBuySimulationPreview();
          }
        }

        function formatSigned(v) {
          if (!Number.isFinite(v)) return "n/a";
          const prefix = v >= 0 ? "+" : "";
          return `${prefix}${v.toFixed(3)}`;
        }

        function renderBuySimulation(sim) {
          if (!sim) return;
          buyTokenTitleEl.textContent = `Buy near ${sim.selected_symbol || "token"} to preview projected market-art impact.`;
          buyClickPointEl.textContent = `(${sim.click_u.toFixed(3)}, ${sim.click_v.toFixed(3)})`;
          buySelectedTokenEl.textContent = `${sim.selected_symbol || "?"} (${sim.selected_token_id || "n/a"})`;
          buySelectedSummaryEl.textContent = `Energy ${sim.selected_before.energy.toFixed(3)} -> ${sim.selected_after.energy.toFixed(3)}, Activity ${sim.selected_before.activity.toFixed(3)} -> ${sim.selected_after.activity.toFixed(3)}, Momentum ${sim.selected_before.momentum.toFixed(3)} -> ${sim.selected_after.momentum.toFixed(3)}`;

          buyImpactListEl.textContent = "";
          for (const item of sim.impact_rows || []) {
            const li = document.createElement("li");
            li.className = "impact-item";
            const left = document.createElement("span");
            left.className = "impact-sym";
            left.textContent = item.symbol || "?";
            const right = document.createElement("span");
            right.className = "impact-delta";
            right.textContent = `dE ${formatSigned(item.delta_energy)} | dA ${formatSigned(item.delta_activity)} | dM ${formatSigned(item.delta_momentum)}`;
            li.appendChild(left);
            li.appendChild(right);
            buyImpactListEl.appendChild(li);
          }
        }

        function refreshBuySimulationFromInput() {
          if (typeof window.computeBuySimulationFromCanvas !== "function") return;
          const buyAmount = Number(buyAmountInput.value || 0);
          const sim = window.computeBuySimulationFromCanvas(buyAmount);
          renderBuySimulation(sim);
          if (typeof window.setBuySimulationPreview === "function") {
            window.setBuySimulationPreview(sim);
          }
        }

        window.openBuySimulation = function openBuySimulation(sim) {
          if (sim && Number.isFinite(sim.buy_amount)) {
            buyAmountInput.value = String(Math.max(1, Math.round(sim.buy_amount)));
          }
          renderBuySimulation(sim);
          if (typeof window.setBuySimulationPreview === "function") {
            window.setBuySimulationPreview(sim);
          }
          buyModal.classList.add("open");
        };

        openHowBtn.addEventListener("click", openHowModal);
        openSourceBtn.addEventListener("click", openSourceModal);
        closeHowBtn.addEventListener("click", closeHowModal);
        closeSourceBtn.addEventListener("click", closeSourceModal);
        closeBuyBtn.addEventListener("click", closeBuyModal);
        enterCanvasBtn.addEventListener("click", closeHowModal);
        seeTokenBtn.addEventListener("click", () => {
          window.open("https://nad.fun/", "_blank", "noopener,noreferrer");
        });
        buyAmountInput.addEventListener("input", refreshBuySimulationFromInput);
        howModal.addEventListener("click", (e) => {
          if (e.target === howModal) closeHowModal();
        });
        sourceModal.addEventListener("click", (e) => {
          if (e.target === sourceModal) closeSourceModal();
        });
        buyModal.addEventListener("click", (e) => {
          if (e.target === buyModal) closeBuyModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeHowModal();
            closeSourceModal();
            closeBuyModal();
          }
        });
      })();
    </script>
  </body>
</html>
